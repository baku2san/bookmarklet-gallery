/**
 * üîñ Gmail Manager - GmailÁÆ°ÁêÜÂäπÁéáÂåñ„ÉÑ„Éº„É´
 *
 * Gmail API„Çí‰ΩøÁî®„Åó„Å¶„ÄÅ„É°„Éº„É´ÁÆ°ÁêÜ„ÇíÂäπÁéáÂåñ„Åô„Çã„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„É¨„ÉÉ„Éà
 *
 * Ê©üËÉΩ:
 * - „É©„Éô„É´„Éª„Éï„Ç©„É´„ÉÄ‰∏ÄË¶ßË°®Á§∫
 * - ÈÄÅ‰ø°ËÄÖÂà•„É°„Éº„É´Áµ±Ë®à
 * - ‰∏ÄÊã¨ÂâäÈô§ÔºàÈÄÅ‰ø°ËÄÖÊåáÂÆöÔºâ
 * - Ëá™Âãï„É©„Éô„É´Ë®≠ÂÆö
 * - Gmail APIË™çË®ºÁÆ°ÁêÜ
 *
 * ÂØæË±°: Gmail (mail.google.com)
 * ‰ΩúÊàêÊó•: 2025-06-24
 *
 * @author Shima
 * @version 2.0.0
 */

(function () {
  'use strict';

  // Gmail „Éâ„É°„Ç§„É≥Á¢∫Ë™ç
  if (!window.location.hostname.includes('mail.google.com')) {
    alert(
      'üîñ Gmail Manager\n\n„Åì„ÅÆ„ÉÑ„Éº„É´„ÅØGmail„Åß„ÅÆ„Åø‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ\nmail.google.com „Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
    );
    return;
  }

  // =============================================================================
  // MemoryManager - „É°„É¢„É™„Éº„É™„Éº„ÇØÂØæÁ≠ñ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ÔºàGmail Manager Áî®Ôºâ
  // =============================================================================
  class MemoryManager {
    constructor(options = {}) {
      this.eventListeners = new Map();
      this.intervals = new Set();
      this.timeouts = new Set();
      this.isCleanedUp = false;
      this.config = {
        enableWarnings: options.enableWarnings !== false,
        debugMode: options.debugMode || false,
        ...options,
      };
    }

    addEventListener(element, type, handler, options = {}) {
      if (this.isCleanedUp || !element || typeof handler !== 'function') return;

      element.addEventListener(type, handler, options);

      if (!this.eventListeners.has(element)) {
        this.eventListeners.set(element, []);
      }

      this.eventListeners.get(element).push({ type, handler, options });
    }

    setInterval(callback, delay, ...args) {
      if (this.isCleanedUp) return null;

      const intervalId = setInterval(callback, delay, ...args);
      this.intervals.add(intervalId);
      return intervalId;
    }

    setTimeout(callback, delay, ...args) {
      if (this.isCleanedUp) return null;

      const timeoutId = setTimeout(() => {
        this.timeouts.delete(timeoutId);
        callback(...args);
      }, delay);

      this.timeouts.add(timeoutId);
      return timeoutId;
    }

    cleanup() {
      if (this.isCleanedUp) return;

      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      for (const [element, listeners] of this.eventListeners.entries()) {
        for (const listener of listeners) {
          try {
            element.removeEventListener(listener.type, listener.handler, listener.options);
          } catch (error) {
            console.warn('Gmail Manager MemoryManager: Error removing event listener:', error);
          }
        }
      }
      this.eventListeners.clear();

      // „Ç§„É≥„Çø„Éº„Éê„É´„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      for (const intervalId of this.intervals) {
        try {
          clearInterval(intervalId);
        } catch (error) {
          console.warn('Gmail Manager MemoryManager: Error clearing interval:', error);
        }
      }
      this.intervals.clear();

      // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      for (const timeoutId of this.timeouts) {
        try {
          clearTimeout(timeoutId);
        } catch (error) {
          console.warn('Gmail Manager MemoryManager: Error clearing timeout:', error);
        }
      }
      this.timeouts.clear();

      this.isCleanedUp = true;

      if (this.config.debugMode) {
        console.log('üß† Gmail Manager: „É°„É¢„É™„Éº„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
      }
    }
  }

  /**
   * Gmail Manager „É°„Ç§„É≥„ÇØ„É©„Çπ
   */
  class GmailManager {
    constructor() {
      this.config = new ConfigManager();
      this.security = new SecurityManager();
      this.ui = new UIManager();
      this.apiManager = new GmailAPIManager();
      this.memoryManager = new MemoryManager({ debugMode: false }); // „É°„É¢„É™„Éº„Éû„Éç„Éº„Ç∏„É£„ÉºËøΩÂä†

      this.state = {
        isAuthenticated: false,
        isApiLoaded: false,
        currentUser: null,
        labels: [],
        selectedLabel: null,
        senderStats: new Map(),
        isProcessing: false,
      };

      this.initialize();
    }

    async initialize() {
      try {
        // „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖß„ÇíË®≠ÂÆöÔºàSecurityManager„ÅåmemoryManager„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
        window.gmailManagerInstance = this;

        // „Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂàùÊúüÂåñ
        await this.security.initialize();

        // UIÂàùÊúüÂåñ
        this.ui.createPanel();

        // APIË®≠ÂÆöË™≠„ÅøËæº„Åø
        await this.config.loadApiConfig();

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        this.setupEventListeners();

        console.log('üì¨ Gmail Manager ÂàùÊúüÂåñÂÆå‰∫Ü');
      } catch (error) {
        console.error('Gmail Manager ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        this.security.logSecurityEvent('INITIALIZATION_ERROR', { error: error.message });
      }
    }

    setupEventListeners() {
      // UI „Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
      this.ui.setupEventListeners(this);
    }

    // Áä∂ÊÖãÁÆ°ÁêÜ„É°„ÇΩ„ÉÉ„Éâ
    updateState(newState) {
      Object.assign(this.state, newState);
    }

    // „É°„É¢„É™„Éº„É™„Éº„ÇØÂØæÁ≠ñ: ÂÆåÂÖ®„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    cleanup() {
      try {
        console.log('üß† Gmail Manager: „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã');

        // „É°„É¢„É™„Éº„Éû„Éç„Éº„Ç∏„É£„Éº„Åß„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        if (this.memoryManager) {
          this.memoryManager.cleanup();
        }

        // „Éë„Éç„É´„ÅÆÂâäÈô§
        if (this.ui) {
          this.ui.removePanel();
        }

        // „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖß„Çí„ÇØ„É™„Ç¢
        if (window.gmailManagerInstance === this) {
          delete window.gmailManagerInstance;
        }

        console.log('üß† Gmail Manager: „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
      } catch (error) {
        console.error('Gmail Manager „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
      }
    }
  }

  /**
   * Ë®≠ÂÆöÁÆ°ÁêÜ„ÇØ„É©„Çπ
   */
  class ConfigManager {
    constructor() {
      this.CONFIG = {
        APP_NAME: 'Gmail Manager',
        VERSION: '2.0.0',
        CLIENT_ID: '',
        API_KEY: '',
        DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
        SCOPES: 'https://www.googleapis.com/auth/gmail.modify',
        PANEL_ID: 'gmail-manager-panel',
        Z_INDEX: 2147483647,
        MAX_MESSAGES_PER_REQUEST: 100,
        BATCH_SIZE: 50,
      };
    }

    async loadApiConfig() {
      try {
        // „Çª„ÉÉ„Ç∑„Éß„É≥Ë®≠ÂÆö„Åã„ÇâË™≠„ÅøËæº„Åø
        const sessionConfig = this.getSessionConfig();
        if (sessionConfig.clientId && sessionConfig.apiKey) {
          this.CONFIG.CLIENT_ID = sessionConfig.clientId;
          this.CONFIG.API_KEY = sessionConfig.apiKey;
          return { clientId: sessionConfig.clientId, apiKey: sessionConfig.apiKey };
        }

        // ÊöóÂè∑ÂåñË®≠ÂÆö„Åã„ÇâË™≠„ÅøËæº„Åø
        const encryptedConfig = this.getEncryptedConfig();
        if (encryptedConfig.clientId && encryptedConfig.apiKey) {
          this.CONFIG.CLIENT_ID = encryptedConfig.clientId;
          this.CONFIG.API_KEY = encryptedConfig.apiKey;
          return encryptedConfig;
        }

        return { clientId: '', apiKey: '' };
      } catch (error) {
        console.error('APIË®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        return { clientId: '', apiKey: '' };
      }
    }

    getSessionConfig() {
      try {
        return {
          clientId: sessionStorage.getItem('gmail-manager-client-id') || '',
          apiKey: sessionStorage.getItem('gmail-manager-api-key') || '',
        };
      } catch {
        return { clientId: '', apiKey: '' };
      }
    }

    getEncryptedConfig() {
      try {
        const encClientId = localStorage.getItem('gmail-manager-client-id-enc');
        const encApiKey = localStorage.getItem('gmail-manager-api-key-enc');

        return {
          clientId: encClientId ? this.simpleDecrypt(encClientId) : '',
          apiKey: encApiKey ? this.simpleDecrypt(encApiKey) : '',
        };
      } catch {
        return { clientId: '', apiKey: '' };
      }
    }

    saveConfig(clientId, apiKey, securityLevel = 'sessionOnly') {
      try {
        if (securityLevel === 'sessionOnly') {
          sessionStorage.setItem('gmail-manager-client-id', clientId);
          sessionStorage.setItem('gmail-manager-api-key', apiKey);
        } else {
          localStorage.setItem('gmail-manager-client-id-enc', this.simpleEncrypt(clientId));
          localStorage.setItem('gmail-manager-api-key-enc', this.simpleEncrypt(apiKey));
        }

        this.CONFIG.CLIENT_ID = clientId;
        this.CONFIG.API_KEY = apiKey;

        return true;
      } catch (error) {
        console.error('Ë®≠ÂÆö‰øùÂ≠ò„Ç®„É©„Éº:', error);
        return false;
      }
    }

    clearConfig() {
      try {
        // „Çª„ÉÉ„Ç∑„Éß„É≥Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢
        sessionStorage.removeItem('gmail-manager-client-id');
        sessionStorage.removeItem('gmail-manager-api-key');

        // ÊöóÂè∑ÂåñË®≠ÂÆö„Çí„ÇØ„É™„Ç¢
        localStorage.removeItem('gmail-manager-client-id-enc');
        localStorage.removeItem('gmail-manager-api-key-enc');

        this.CONFIG.CLIENT_ID = '';
        this.CONFIG.API_KEY = '';

        return true;
      } catch (error) {
        console.error('Ë®≠ÂÆö„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
        return false;
      }
    }

    simpleEncrypt(text) {
      return btoa(
        text
          .split('')
          .map(char => String.fromCharCode(char.charCodeAt(0) + 3))
          .join('')
      );
    }

    simpleDecrypt(encodedText) {
      return atob(encodedText)
        .split('')
        .map(char => String.fromCharCode(char.charCodeAt(0) - 3))
        .join('');
    }
  }

  /**
   * „Çª„Ç≠„É•„É™„ÉÜ„Ç£ÁÆ°ÁêÜ„ÇØ„É©„Çπ
   */
  class SecurityManager {
    constructor() {
      this.SECURITY_CONFIG = {
        SESSION_TIMEOUT: 30 * 60 * 1000,
        MAX_FAILED_ATTEMPTS: 3,
        LOCKOUT_DURATION: 15 * 60 * 1000,
        ALLOWED_DOMAINS: ['mail.google.com'],
      };

      this.securityState = {
        sessionStartTime: Date.now(),
        lastActivityTime: Date.now(),
        failedAttempts: 0,
        isLockedOut: false,
        lockoutTime: null,
        sessionId: this.generateSessionId(),
        cspViolations: [],
      };
    }

    async initialize() {
      this.setupCSPMonitoring();
      this.startSecurityChecks();
      this.logSecurityEvent('SECURITY_INITIALIZED');
    }

    generateSessionId() {
      return 'gm_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    sanitizeHTML(input) {
      if (typeof input !== 'string') return input;

      return input
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;')
        .replace(/\//g, '&#x2F;');
    }

    detectXSSPatterns(input) {
      if (typeof input !== 'string') return false;

      const dangerousPatterns = [
        /<script[^>]*>.*?<\/script>/gi,
        /<iframe[^>]*>.*?<\/iframe>/gi,
        /javascript:/gi,
        /on\w+\s*=/gi,
        /eval\s*\(/gi,
      ];

      return dangerousPatterns.some(pattern => pattern.test(input));
    }

    isSessionValid() {
      const now = Date.now();
      const sessionAge = now - this.securityState.sessionStartTime;
      const inactivityTime = now - this.securityState.lastActivityTime;

      if (sessionAge > this.SECURITY_CONFIG.SESSION_TIMEOUT) {
        this.expireSession('„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
        return false;
      }

      if (inactivityTime > 15 * 60 * 1000) {
        this.expireSession('Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅÆ„Åü„ÇÅ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü');
        return false;
      }

      return true;
    }

    recordActivity() {
      this.securityState.lastActivityTime = Date.now();
    }

    expireSession(reason) {
      console.warn(`üö® „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü: ${reason}`);

      // UIË¶ÅÁ¥†„ÇíÂâäÈô§
      const panel = document.getElementById('gmail-manager-panel');
      if (panel) {
        panel.remove();
      }

      alert(`üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£: ${reason}\n\nGmail Manager„ÇíÂÜçËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
    }

    checkIntegrity() {
      const panel = document.getElementById('gmail-manager-panel');
      if (!panel) return true;

      // ‰∏çÊ≠£„Å™„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
      const scripts = panel.querySelectorAll('script');
      if (scripts.length > 0) {
        console.error('üö® „Ç§„É≥„ÉÜ„Ç∞„É™„ÉÜ„Ç£ÈÅïÂèç: ‰∏çÊ≠£„Å™„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíÊ§úÂá∫');
        return false;
      }

      // Âç±Èô∫„Å™Â±ûÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
      const dangerousElements = panel.querySelectorAll('[onclick], [onload], [onerror]');
      if (dangerousElements.length > 0) {
        console.error('üö® „Ç§„É≥„ÉÜ„Ç∞„É™„ÉÜ„Ç£ÈÅïÂèç: Âç±Èô∫„Å™„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÇíÊ§úÂá∫');
        return false;
      }

      return true;
    }

    setupCSPMonitoring() {
      // parent GmailManager „Ç§„É≥„Çπ„Çø„É≥„Çπ„Åã„ÇâmemoryManager„ÇíÂèñÂæó
      const memoryManager = window.gmailManagerInstance?.memoryManager;

      if (memoryManager) {
        memoryManager.addEventListener(document, 'securitypolicyviolation', event => {
          console.error('üö® CSPÈÅïÂèç:', event);
          this.securityState.cspViolations.push({
            violatedDirective: event.violatedDirective,
            blockedURI: event.blockedURI,
            timestamp: Date.now(),
          });

          if (event.violatedDirective.includes('script-src')) {
            this.expireSession('CSP„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÈÅïÂèç„ÇíÊ§úÂá∫');
          }
        });
      } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂæìÊù•„ÅÆÊñπÊ≥ïÔºâ
        document.addEventListener('securitypolicyviolation', event => {
          console.error('üö® CSPÈÅïÂèç:', event);
          this.securityState.cspViolations.push({
            violatedDirective: event.violatedDirective,
            blockedURI: event.blockedURI,
            timestamp: Date.now(),
          });

          if (event.violatedDirective.includes('script-src')) {
            this.expireSession('CSP„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÈÅïÂèç„ÇíÊ§úÂá∫');
          }
        });
      }
    }

    startSecurityChecks() {
      // parent GmailManager „Ç§„É≥„Çπ„Çø„É≥„Çπ„Åã„ÇâmemoryManager„ÇíÂèñÂæó
      const memoryManager = window.gmailManagerInstance?.memoryManager;

      if (memoryManager) {
        this.securityCheckInterval = memoryManager.setInterval(() => {
          if (!this.checkIntegrity() || !this.isSessionValid()) {
            this.expireSession('„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó');
          }
        }, 60000);
      } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂæìÊù•„ÅÆÊñπÊ≥ïÔºâ
        this.securityCheckInterval = setInterval(() => {
          if (!this.checkIntegrity() || !this.isSessionValid()) {
            this.expireSession('„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó');
          }
        }, 60000);
      }
    }

    logSecurityEvent(event, details = {}) {
      const logEntry = {
        timestamp: new Date().toISOString(),
        sessionId: this.securityState.sessionId,
        event: event,
        details: details,
        url: window.location.href,
      };

      console.log('üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É≠„Ç∞:', logEntry);

      if (event.includes('ATTACK') || event.includes('VIOLATION')) {
        this.securityState.failedAttempts++;

        if (this.securityState.failedAttempts >= this.SECURITY_CONFIG.MAX_FAILED_ATTEMPTS) {
          this.securityState.isLockedOut = true;
          this.expireSession('„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÊîªÊíÉ„ÇíÊ§úÁü•Ôºö„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà');
        }
      }
    }
  }

  /**
   * UIÁÆ°ÁêÜ„ÇØ„É©„Çπ
   */
  class UIManager {
    constructor() {
      this.PANEL_ID = 'gmail-manager-panel';
      this.Z_INDEX = 2147483647;
    }

    createPanel() {
      // Êó¢Â≠ò„Éë„Éç„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ„ÉªÂâäÈô§
      const existingPanel = document.getElementById(this.PANEL_ID);
      if (existingPanel) {
        existingPanel.remove();
      }

      // „Çπ„Çø„Ç§„É´ËøΩÂä†
      this.addStyles();

      // „É°„Ç§„É≥„Éë„Éç„É´
      const panel = this.createElement('div');
      panel.id = this.PANEL_ID;

      // „Éë„Éç„É´ÊßãÊàêË¶ÅÁ¥†„Çí‰ΩúÊàê
      panel.appendChild(this.createHeader());
      panel.appendChild(this.createTabs());
      panel.appendChild(this.createContent());

      document.body.appendChild(panel);
    }

    createElement(tag, className = '', textContent = '') {
      const element = document.createElement(tag);
      if (className) element.className = className;
      if (textContent) element.textContent = textContent;
      return element;
    }

    createHeader() {
      const header = this.createElement('div', 'gm-header');
      const title = this.createElement('div', 'gm-title', 'üì¨ Gmail Manager');
      const closeBtn = this.createElement('button', 'gm-close-btn', '√ó');

      header.appendChild(title);
      header.appendChild(closeBtn);
      return header;
    }

    createTabs() {
      const tabs = this.createElement('div', 'gm-tabs');
      const tabsData = [
        { id: 'auth', label: 'üîê Ë™çË®º', active: true },
        { id: 'labels', label: 'üìÅ „É©„Éô„É´' },
        { id: 'senders', label: 'üë• ÈÄÅ‰ø°ËÄÖ' },
        { id: 'delete', label: 'üóëÔ∏è ÂâäÈô§' },
      ];

      tabsData.forEach(tab => {
        const tabBtn = this.createElement(
          'button',
          `gm-tab${tab.active ? ' active' : ''}`,
          tab.label
        );
        tabBtn.dataset.tab = tab.id;
        tabs.appendChild(tabBtn);
      });

      return tabs;
    }

    createContent() {
      const content = this.createElement('div', 'gm-content');

      content.appendChild(this.createAuthTab());
      content.appendChild(this.createLabelsTab());
      content.appendChild(this.createSendersTab());
      content.appendChild(this.createDeleteTab());

      return content;
    }

    createAuthTab() {
      const tab = this.createElement('div', 'gm-tab-content active');
      tab.id = 'gm-tab-auth';

      // Ë™çË®ºÁä∂ÊÖãË°®Á§∫
      const authStatus = this.createElement('div', 'gm-status');
      authStatus.id = 'gm-auth-status';
      authStatus.textContent = 'Gmail API„Å∏„ÅÆË™çË®º„ÅåÂøÖË¶Å„Åß„Åô';

      // APIË®≠ÂÆö„Éï„Ç©„Éº„É†
      const configForm = this.createConfigForm();

      tab.appendChild(authStatus);
      tab.appendChild(configForm);

      return tab;
    }

    createConfigForm() {
      const form = this.createElement('div', 'gm-config-form');

      // Client IDÂÖ•Âäõ
      const clientIdGroup = this.createElement('div', 'gm-form-group');
      clientIdGroup.appendChild(this.createElement('label', '', 'Client ID:'));
      const clientIdInput = this.createElement('input');
      clientIdInput.type = 'text';
      clientIdInput.id = 'gm-client-id';
      clientIdInput.placeholder = 'Google Cloud Console „ÅßÂèñÂæó„Åó„ÅüClient ID„ÇíÂÖ•Âäõ';
      clientIdGroup.appendChild(clientIdInput);

      // API KeyÂÖ•Âäõ
      const apiKeyGroup = this.createElement('div', 'gm-form-group');
      apiKeyGroup.appendChild(this.createElement('label', '', 'API Key:'));
      const apiKeyInput = this.createElement('input');
      apiKeyInput.type = 'text';
      apiKeyInput.id = 'gm-api-key';
      apiKeyInput.placeholder = 'Google Cloud Console „ÅßÂèñÂæó„Åó„ÅüAPI Key„ÇíÂÖ•Âäõ';
      apiKeyGroup.appendChild(apiKeyInput);

      // „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¨„Éô„É´ÈÅ∏Êäû
      const securityGroup = this.createElement('div', 'gm-form-group');
      securityGroup.appendChild(this.createElement('label', '', 'üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¨„Éô„É´:'));
      const securitySelect = this.createElement('select');
      securitySelect.id = 'gm-security-level';

      const sessionOption = this.createElement('option');
      sessionOption.value = 'sessionOnly';
      sessionOption.textContent = 'üîê „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„ÅøÔºàÊé®Â•®„ÉªÊúÄ„ÇÇÂÆâÂÖ®Ôºâ';
      sessionOption.selected = true;

      const encryptedOption = this.createElement('option');
      encryptedOption.value = 'encrypted';
      encryptedOption.textContent = 'üîí ÊöóÂè∑Âåñ‰øùÂ≠òÔºàÊ∞∏Á∂ö‰øùÂ≠òÔºâ';

      securitySelect.appendChild(sessionOption);
      securitySelect.appendChild(encryptedOption);
      securityGroup.appendChild(securitySelect);

      // „Éú„Çø„É≥Áæ§
      const buttonGroup = this.createElement('div', 'gm-button-group');
      buttonGroup.appendChild(this.createElement('button', 'gm-btn primary', 'üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò'));
      buttonGroup.appendChild(this.createElement('button', 'gm-btn', 'üóëÔ∏è Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢'));
      buttonGroup.appendChild(this.createElement('button', 'gm-btn', 'üìñ Ë®≠ÂÆö„Ç¨„Ç§„Éâ'));

      form.appendChild(clientIdGroup);
      form.appendChild(apiKeyGroup);
      form.appendChild(securityGroup);
      form.appendChild(buttonGroup);

      return form;
    }

    createLabelsTab() {
      const tab = this.createElement('div', 'gm-tab-content');
      tab.id = 'gm-tab-labels';

      const labelsStatus = this.createElement('div', 'gm-status');
      labelsStatus.textContent = '„É©„Éô„É´‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...';

      const labelsList = this.createElement('div', 'gm-list');
      labelsList.id = 'gm-labels-list';

      tab.appendChild(labelsStatus);
      tab.appendChild(labelsList);

      return tab;
    }

    createSendersTab() {
      const tab = this.createElement('div', 'gm-tab-content');
      tab.id = 'gm-tab-senders';

      const sendersStatus = this.createElement('div', 'gm-status');
      sendersStatus.textContent = 'ÈÄÅ‰ø°ËÄÖÁµ±Ë®à„ÇíË™≠„ÅøËæº„Åø‰∏≠...';

      const sendersList = this.createElement('div', 'gm-list');
      sendersList.id = 'gm-senders-list';

      tab.appendChild(sendersStatus);
      tab.appendChild(sendersList);

      return tab;
    }

    createDeleteTab() {
      const tab = this.createElement('div', 'gm-tab-content');
      tab.id = 'gm-tab-delete';

      const deleteStatus = this.createElement('div', 'gm-status');
      deleteStatus.textContent = '‰∏ÄÊã¨ÂâäÈô§Ê©üËÉΩ';

      const deleteControls = this.createElement('div', 'gm-delete-controls');
      deleteControls.appendChild(this.createElement('button', 'gm-btn primary', 'üóëÔ∏è ÈÅ∏ÊäûÂâäÈô§'));

      tab.appendChild(deleteStatus);
      tab.appendChild(deleteControls);

      return tab;
    }

    setupEventListeners(gmailManager) {
      // MemoryManager „ÇíÂèñÂæó
      const memoryManager = gmailManager.memoryManager;

      // „Çø„ÉñÂàá„ÇäÊõø„Åà
      if (memoryManager) {
        memoryManager.addEventListener(document, 'click', e => {
          if (e.target.classList.contains('gm-tab')) {
            this.switchTab(e.target.dataset.tab);
          }

          // Èñâ„Åò„Çã„Éú„Çø„É≥
          if (e.target.classList.contains('gm-close-btn')) {
            // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å„Åó„Å¶„Åã„Çâ„Éë„Éç„É´„ÇíÂâäÈô§
            gmailManager.cleanup();
            const panel = document.getElementById(this.PANEL_ID);
            if (panel) panel.remove();
          }

          // Ë®≠ÂÆö‰øùÂ≠ò„Éú„Çø„É≥
          if (e.target.textContent.includes('Ë®≠ÂÆö„Çí‰øùÂ≠ò')) {
            this.saveConfig(gmailManager);
          }

          // Ë®≠ÂÆö„ÇØ„É™„Ç¢„Éú„Çø„É≥
          if (e.target.textContent.includes('Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢')) {
            this.clearConfig(gmailManager);
          }
        });
      } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂæìÊù•„ÅÆÊñπÊ≥ïÔºâ
        document.addEventListener('click', e => {
          if (e.target.classList.contains('gm-tab')) {
            this.switchTab(e.target.dataset.tab);
          }

          // Èñâ„Åò„Çã„Éú„Çø„É≥
          if (e.target.classList.contains('gm-close-btn')) {
            const panel = document.getElementById(this.PANEL_ID);
            if (panel) panel.remove();
          }

          // Ë®≠ÂÆö‰øùÂ≠ò„Éú„Çø„É≥
          if (e.target.textContent.includes('Ë®≠ÂÆö„Çí‰øùÂ≠ò')) {
            this.saveConfig(gmailManager);
          }

          // Ë®≠ÂÆö„ÇØ„É™„Ç¢„Éú„Çø„É≥
          if (e.target.textContent.includes('Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢')) {
            this.clearConfig(gmailManager);
          }
        });
      }
    }

    switchTab(tabId) {
      // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
      document.querySelectorAll('.gm-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

      // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
      document.querySelectorAll('.gm-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`gm-tab-${tabId}`).classList.add('active');
    }

    saveConfig(gmailManager) {
      const clientId = document.getElementById('gm-client-id').value.trim();
      const apiKey = document.getElementById('gm-api-key').value.trim();
      const securityLevel = document.getElementById('gm-security-level').value;

      if (!clientId || !apiKey) {
        alert('Client ID„Å®API Key„ÅÆ‰∏°Êñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      if (gmailManager.config.saveConfig(clientId, apiKey, securityLevel)) {
        alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
        this.updateAuthStatus('Ë®≠ÂÆö‰øùÂ≠òÂÆå‰∫Ü');
      } else {
        alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
      }
    }

    clearConfig(gmailManager) {
      if (confirm('Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
        if (gmailManager.config.clearConfig()) {
          document.getElementById('gm-client-id').value = '';
          document.getElementById('gm-api-key').value = '';
          alert('Ë®≠ÂÆö„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ');
          this.updateAuthStatus('Ë®≠ÂÆö„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åó„Åü');
        }
      }
    }

    updateAuthStatus(message) {
      const authStatus = document.getElementById('gm-auth-status');
      if (authStatus) {
        authStatus.textContent = message;
      }
    }

    // „É°„É¢„É™„Éº„É™„Éº„ÇØÂØæÁ≠ñ: „Éë„Éç„É´ÂâäÈô§
    removePanel() {
      const panel = document.getElementById(this.PANEL_ID);
      if (panel) {
        panel.remove();
      }

      // Ê≥®ÂÖ•„Åó„Åü„Çπ„Çø„Ç§„É´„ÇÇÂâäÈô§
      const style = document.getElementById('gm-styles');
      if (style) {
        style.remove();
      }
    }

    addStyles() {
      const style = document.createElement('style');
      style.id = 'gm-styles';
      style.textContent = this.getCSS();
      document.head.appendChild(style);
    }

    getCSS() {
      return `
        #${this.PANEL_ID} {
          position: fixed;
          top: 50px;
          right: 50px;
          width: 450px;
          max-height: 600px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          border-radius: 16px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          z-index: ${this.Z_INDEX};
          color: white;
          overflow: hidden;
          backdrop-filter: blur(10px);
        }

        #${this.PANEL_ID} * {
          box-sizing: border-box;
        }

        .gm-header {
          background: rgba(255,255,255,0.1);
          padding: 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .gm-title {
          font-size: 20px;
          font-weight: 700;
          margin: 0;
        }

        .gm-close-btn {
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 16px;
          transition: all 0.2s ease;
        }

        .gm-close-btn:hover {
          background: rgba(255,255,255,0.3);
          transform: scale(1.1);
        }

        .gm-tabs {
          display: flex;
          background: rgba(255,255,255,0.1);
        }

        .gm-tab {
          flex: 1;
          padding: 15px 10px;
          background: none;
          border: none;
          color: rgba(255,255,255,0.7);
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s ease;
          text-align: center;
        }

        .gm-tab.active {
          background: rgba(255,255,255,0.2);
          color: white;
          font-weight: 600;
        }

        .gm-tab:hover {
          background: rgba(255,255,255,0.15);
          color: white;
        }

        .gm-content {
          padding: 20px;
          max-height: 450px;
          overflow-y: auto;
        }

        .gm-tab-content {
          display: none;
        }

        .gm-tab-content.active {
          display: block;
        }

        .gm-form-group {
          margin-bottom: 15px;
        }

        .gm-form-group label {
          display: block;
          margin-bottom: 5px;
          font-size: 12px;
        }

        .gm-form-group input,
        .gm-form-group select {
          width: 100%;
          padding: 8px;
          border-radius: 4px;
          border: 1px solid rgba(255,255,255,0.3);
          background: rgba(255,255,255,0.1);
          color: white;
          font-size: 12px;
        }

        .gm-form-group input::placeholder {
          color: rgba(255,255,255,0.6);
        }

        .gm-btn {
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          padding: 10px 15px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 12px;
          margin: 5px 5px 5px 0;
          transition: all 0.2s ease;
          min-width: 80px;
        }

        .gm-btn:hover {
          background: rgba(255,255,255,0.3);
          transform: translateY(-1px);
        }

        .gm-btn.primary {
          background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
          font-weight: 600;
        }

        .gm-btn.primary:hover {
          background: linear-gradient(45deg, #FF5252, #26A69A);
        }

        .gm-status {
          background: rgba(255,255,255,0.1);
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 15px;
          font-size: 14px;
          line-height: 1.4;
        }

        .gm-list {
          max-height: 200px;
          overflow-y: auto;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
          padding: 10px;
        }

        .gm-button-group {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
        }
      `;
    }
  }

  /**
   * Gmail APIÁÆ°ÁêÜ„ÇØ„É©„Çπ
   */
  class GmailAPIManager {
    constructor(config) {
      this.config = config;
      this.isLoaded = false;
      this.isAuthenticated = false;
    }

    async loadGoogleAPI() {
      return new Promise((resolve, reject) => {
        if (typeof gapi !== 'undefined') {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Google APIË™≠„ÅøËæº„ÅøÂ§±Êïó'));
        document.head.appendChild(script);
      });
    }

    async initializeAPI() {
      try {
        await this.loadGoogleAPI();

        await new Promise(resolve => {
          gapi.load('client:auth2', resolve);
        });

        await gapi.client.init({
          apiKey: this.config.CONFIG.API_KEY,
          clientId: this.config.CONFIG.CLIENT_ID,
          discoveryDocs: this.config.CONFIG.DISCOVERY_DOCS,
          scope: this.config.CONFIG.SCOPES,
        });

        this.isLoaded = true;
        return true;
      } catch (error) {
        console.error('Gmail APIÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        return false;
      }
    }

    async authenticate() {
      try {
        if (!this.isLoaded) {
          throw new Error('API„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        }

        const authInstance = gapi.auth2.getAuthInstance();
        if (!authInstance.isSignedIn.get()) {
          await authInstance.signIn();
        }

        this.isAuthenticated = true;
        return true;
      } catch (error) {
        console.error('Ë™çË®º„Ç®„É©„Éº:', error);
        return false;
      }
    }

    async getLabels() {
      try {
        if (!this.isAuthenticated) {
          throw new Error('Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô');
        }

        const response = await gapi.client.gmail.users.labels.list({
          userId: 'me',
        });

        return response.result.labels || [];
      } catch (error) {
        console.error('„É©„Éô„É´ÂèñÂæó„Ç®„É©„Éº:', error);
        return [];
      }
    }

    async getMessages(labelId = null, maxResults = 100) {
      try {
        if (!this.isAuthenticated) {
          throw new Error('Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô');
        }

        const params = {
          userId: 'me',
          maxResults: maxResults,
        };

        if (labelId) {
          params.labelIds = [labelId];
        }

        const response = await gapi.client.gmail.users.messages.list(params);
        return response.result.messages || [];
      } catch (error) {
        console.error('„É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Ç®„É©„Éº:', error);
        return [];
      }
    }
  }

  /**
   * Gmail Manager „ÇíÂàùÊúüÂåñ„Åó„Å¶ÈñãÂßã
   */
  function initializeGmailManager() {
    try {
      const gmailManager = new GmailManager();
      console.log('üì¨ Gmail Manager „ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');

      // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®Ôºà„Éá„Éê„ÉÉ„Ç∞ÁõÆÁöÑÔºâ
      window.gmailManager = gmailManager;
    } catch (error) {
      console.error('Gmail Manager ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
      alert('Gmail Manager „ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    }
  }

  // ÂàùÊúüÂåñÂÆüË°å
  initializeGmailManager();
})();
